---
title: "Comparative genomics of *P. damicornis* and scleractinian corals"
author: "Ross Cunning"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache = TRUE)
knitr::opts_knit$set(root.dir = normalizePath(".."))
library(Biostrings)
library(stringr)
library(tidyverse)
library(VennDiagram)
library(lsmeans)
library(RColorBrewer)
```

```{r load_data_and_functions, include=FALSE}
# Load gene family count data (includes singletons)
load("fastOrtho/counts.RData")

# Define function to get total number of ortholog groups in a species (or shared by a group of species)
nfam <- function(spp) {
  out <- counts
  for (sp in spp) {
    out <- out[out[, sp] > 0, ]
  }
  nrow(out)
}

# Define function to plot venn diagram of ortholog groups across n species
plotGeneFams <- function(a, ...) {
  grid.newpage()
  if (length(a) == 1) {
    out <- draw.single.venn(nfam(a), ...)
  }
  if (length(a) == 2) {
    out <- draw.pairwise.venn(nfam(a[1]), nfam(a[2]), nfam(a[1:2]), ...)
  }
  if (length(a) == 3) {
    out <- draw.triple.venn(nfam(a[1]), nfam(a[2]), nfam(a[3]), nfam(a[1:2]), 
                            nfam(a[2:3]), nfam(a[c(1, 3)]), nfam(a), ...)
  }
  if (length(a) == 4) {
    out <- draw.quad.venn(nfam(a[1]), nfam(a[2]), nfam(a[3]), nfam(a[4]), 
                          nfam(a[1:2]), nfam(a[c(1, 3)]), nfam(a[c(1, 4)]), nfam(a[2:3]), 
                          nfam(a[c(2, 4)]), nfam(a[3:4]), nfam(a[1:3]), nfam(a[c(1, 2, 4)]), 
                          nfam(a[c(1, 3, 4)]), nfam(a[2:4]), nfam(a), ...)
  }
  if (!exists("out")) 
    out <- "Oops"
  return(out)
}

# Define function to calculate dissimilarity among species based on shared gene families
genedist <- function(a, b) {
  1 - (nfam(c(a, b)) / (nfam(a) + nfam(b)))
}

# Define function to make italic labels for plots
make.italic <- function(x) as.expression(lapply(x, function(y) bquote(italic(.(y)))))
```

# Genome statistics

|        |*Pdam*|*Spis*[^a]|*Adig*[^b]|*Ofav*[^c]|*Disc*[^d]|*Afen*[^d]|*Aipt*[^e]|*Nema*[^f]|*Hydr*[^g]|*Mlei*[^h]|*Aque*[^i]|
| --------------------- | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| Genome size (Mb)      | 348^\$^| 434    | 420    |        | 428    | 350    | 260    | 329[^e]| 1300   |        | 190
| Assembly size (Mb)    | 234    | 400    | 419    | 486    | 445    | 370    | 258    | 356    | 852    | 156    | 167
| Total contig size (Mb)| 226    | 358    | 365    | 356    | 364    | 306    | 213    | 297    | 785    | 150    | 145
| Contig / Assembly (%) | 96.3   | 89.5   | 87.0   | 73.3   | 81.9   | 82.6   | 82.5   | 83.4   | 92.2   | 96.5   | 86.8
| Contig N50 (kb)       | 25.9   | 14.9   | 10.9   | 7.4    | 18.7   | 20.1   | 14.9   | 19.8   | 9.7    | 11.9   | 11.2
| Scaffold N50 (kb)     | 326    | 457    | 191    | 1162   | 770    | 510    | 440    | 472    | 92.5   | 187    | 120
| # Gene models         | 26,077 |25,769\*| 23,668 | 37,660 | 23,199 | 21,372 | 29,269 | 27,273 | 31,452 | 16,554 | 29,867
| # Complete gene models| 21,389 |25,563\*| 16,434 | 29,679 |16,082\*|15,552\*| 26,658 | 13,343 |        |        |
| BUSCO completeness (%)| 88.4   | 72.2   | 34.3   | 71.0   |        |        |        |        |        |        |
| Mean exon length (bp) | 245    | 262\*  | 230    | 240    | 226    | 218    | 354    | 208    |        | 314    | 
| Mean intron len. (bp) | 667    | 917\*  | 952    | 1146   | 1119   | 1047   | 638    | 800    |        | 898    | 80
| Mean protein len. (aa)| 455    | 615\*  | 424    | 413    | 450\*  | 475\*  | 517    | 331    |        | 154?   | 280(med)

[^a]: Voolstra et al., bioRxiv
[^b]: @Shinzato2011
[^c]: @Prada2016a. Assembly was downloaded (https://www.ncbi.nlm.nih.gov/genome/?term=txid48498) and re-annotated using the pipeline from the present study (github.com/jrcunning/ofav-genome)
[^d]: @Wang2017a
[^e]: @Baumgarten2015
[^f]: @Putnam2007
[^g]: @Chapman2010
[^h]: @Ryan2013
[^i]: @Srivastava2010

\* Calculated in this study using GAG based on downloaded data  
\^ Calculated in this study using RepeatModeler and RepeatMasker  
^\$^ Computed as the total occurrences for non-error k-mers divided by the homozygous-peak depth (Dovetail Genomics Assembly Report)

#### Conclusions:
* Pdam assembly is most complete coral genome to date
* Genome structure is similar to other corals

***

# Whole-proteome feature frequency profiling

This approach generates a distance matrix based on the frequency with which specific amino acid substrings (i.e., words) occur throughout the proteome. This is an alignment-free approach to creating a whole-proteome phylogeny. Running this analysis produces a tree that exactly matches evolutionary relationships among these taxa:

```{r ffp-tree}

library(ape)

tree <- ape::read.tree("ffp/tree")
tree <- root(tree, "Mnemiopsis")
tree <- drop.tip(tree, c(1,3,6))
plot(tree)
```

***

# Gene content analysis

## Basic information about gene family groupings
```{r}
# How many gene families, including singletons, were found across all the genomes?
nrow(counts)  # 98,499
# How many non-singleton gene families were found across all genomes?
nrow(counts[rowSums(counts) > 1, ])

# How many gene families, including singletons, were found in at least one scleractinian?
nrow(counts[rowSums(counts[, 1:4] > 0), ])  # 43580
```


## Compare scleractinian species
```{r compare_corals, results='hide'}
png(filename="figures/coral_venn.png", width=3, height=2.5, units="in", res=300)
# Compare four coral species
## Venn diagram
plotGeneFams(c("Pdam", "Adig", "Spis", "Ofav"), 
             category=make.italic(c("P. damicornis", "A. digitifera", 
                                    "S. pistillata", "O. faveolata")), 
             lty="blank", fill=c("skyblue", "pink1", "mediumorchid", "gray60"),
             cat.cex=0.75, cex=0.75, margin=0.075)
dev.off()

plotGeneFams(c("Pdam", "Ofav", "Spis", "Adig"), 
             category=make.italic(c("P. damicornis", "A. digitifera", 
                                    "S. pistillata", "O. faveolata")), 
             lty="blank", fill=c("skyblue", "pink1", "mediumorchid", "gray60"))

## Dendrogram
l <- t(combn(c("Pdam", "Spis", "Adig", "Ofav"), 2))
gd <- apply(l, 1, function(p) genedist(p[1], p[2]))
df <- data.frame(cbind(l, gd))
dm <- reshape(df, direction="wide", idvar="V2", timevar="V1")
dm <- cbind(rbind(rep(NA, 4), dm), rep(NA, 4))
dm <- dm[,-1]
rownames(dm) <- c("Pdam", "Spis", "Adig", "Ofav")
colnames(dm) <- c("Pdam", "Spis", "Adig", "Ofav")

dd <- as.dendrogram(hclust(as.dist(dm)))
dd.reorder <- reorder(dd, c(1,3,2222222,1111111))
plot(as.hclust(dd.reorder), xlab=NA, sub=NA, yaxt="n", ylab=NA, main=NA, cex=0.75)

png("figures/coral_genecontent_dendro.png", width=2, height=1, units="in", res=300)
par(mar=c(0,0,0,0))
plot(as.hclust(dd.reorder), xlab=NA, sub=NA, yaxt="n", ylab=NA, main=NA, cex=0.75)
dev.off()

```

Venn diagram shows the number of gene families shared by each of the four coral species. A pairwise similarity metric can be calculated for each pair of corals as the number of shared gene families divided by their total number of gene families (based on Snel et al. 1999). Based on this similarity metric, a dendrogram can be created showing the relationships among all four corals:

#### Conclusions: 
* *Relationships based on shared gene families are consistent with evolutionary phylogeny*

## Compare all genomes
```{r compare_all_genomes, results='hide'}
# Find 'core gene families' of each order - those shared by each member.
#counts$Scleractinia <- apply(counts[, 1:4], 1, function(x) as.numeric(any(x==0)==FALSE))
#counts$Corallimorpharia <- apply(counts[, 5:6], 1, function(x) as.numeric(any(x==0)==FALSE))
#counts$Actinaria <- apply(counts[, 7:8], 1, function(x) as.numeric(any(x==0)==FALSE))
#counts$Anthomedusae <- sapply(counts[, 9], function(x) as.numeric(any(x==0)==FALSE))
#counts$allBasal <- apply(counts[, 10:11], 1, function(x) as.numeric(any(x==0)==FALSE))

# Compare 4 cnidarian orders
#plotGeneFams(c("Scleractinia", "Corallimorpharia", "Actinaria", "Anthomedusae"), 
#             category=c("Scleractinia", "Corallimorpharia", "Actinaria", "Anthomedusae"),
#             lty="blank", fill=c("skyblue", "pink1", "mediumorchid", "gray60"))

#l <- t(combn(c("Scleractinia", "Corallimorpharia", "Actinaria", "Anthomedusae"), 2))
#gd <- apply(l, 1, function(p) genedist(p[1], p[2]))
#df <- data.frame(cbind(l, gd))
#dm <- reshape(df, direction="wide", idvar="V2", timevar="V1")
#dm <- cbind(rbind(rep(NA, 4), dm), rep(NA, 4))
#dm <- dm[,-1]
#rownames(dm) <- c("Scleractinia", "Corallimorpharia", "Actinaria", "Anthomedusae")
#colnames(dm) <- c("Scleractinia", "Corallimorpharia", "Actinaria", "Anthomedusae")
#dm

#plot(hclust(as.dist(dm)), xlab=NA, sub=NA,
#     main="Gene content dendrogram")


l <- t(combn(c("Pdam", "Spis", "Ofav", "Adig", "Aipt", "Hydr", "Nema", "Disc", "Ampl", "Mnem", "Amph"), 2))
gd <- apply(l, 1, function(p) genedist(p[1], p[2]))
df <- data.frame(cbind(l, gd))
dm <- reshape(df, direction="wide", idvar="V2", timevar="V1")
dm <- cbind(rbind(rep(NA, 11), dm), rep(NA, 11))
dm <- dm[,-1]
rownames(dm) <- c("Pdam", "Spis", "Ofav", "Adig", "Aipt", "Hydr", "Nema", "Disc", "Ampl", "Mnem", "Amph")
colnames(dm) <- c("Pdam", "Spis", "Ofav", "Adig", "Aipt", "Hydr", "Nema", "Disc", "Ampl", "Mnem", "Amph")
dm

plot(hclust(as.dist(dm)), xlab=NA, sub=NA,
     main="All genomes: gene content dendrogram")
```

#### Conclusions:  
*Relationships based on shared gene families put Scleractinians closer to Actinians than Corallimporpharians, which is inconsistent with evolutionary phylogeny.*

I am not sure why phylogeny based on gene content (shared ortholog groups) is discordant with the feature frequency profile phylogeny and accepted evolutionary phylogeny. I am also not sure whether this is significant and worth following up on... Does this suggest either convergent evolution in scleractinians and actinians, or rapid diversification (and/or loss) of genes in corallimorpharians?

***

# Functional analysis of gene content

## Coral core genes
```{r coral_core}
coralCore <- counts[apply(counts[,1:4], 1, function(x) min(x)>0), ]
n.coral.core <- nrow(coralCore)

# Number of P. damicornis genes that are members of coral core gene families
sum(coralCore$Pdam)
sum(coralCore$Pdam) / sum(counts$Pdam)

present.all.cni <- sum(apply(coralCore[,5:9], 1, function(x) min(x)>0))
pct.all.cni <- present.all.cni / n.coral.core

present.one <- sum(apply(coralCore[,-(1:4)], 1, function(x) max(x)>0))
pct.present.one <- present.one / n.coral.core
```

The coral core genome (orthologs present in all four scleractinians) includes `r n.coral.core` gene families. Of these genes, `r round(pct.all.cni * 100, 1)`% are present in all other cnidarians, and `r round(pct.present.one * 100, 2)`% are present in at least one non-coral genome. Functional analysis of these core genes in *P. damicornis* revealed enrichment of 44 GO terms. REVIGO visualization:

![](../coral_core/coral_core_enriched_revigo.png)

## Coral-specific genes
```{r coral_specific}
coral.specific <- apply(counts, 1, function(x) min(x[1:4]>0) & max(x[-(1:4)])==0)
coral.specific.orthos <- counts[coral.specific, ]
n.coral.specific.orthos <- nrow(coral.specific.orthos)
n.coral.specific.singletons <-with(coral.specific.orthos, sum(Pdam==1 & Spis==1 & Adig==1 & Ofav==1))
n.coral.specific.genes <- sum(coral.specific.orthos[,1]) #(in Pdam)
```

This is a set of genes for which orthologs were present *in all coral genomes* but *NOT* in any of the other genomes. There were `r n.coral.specific.orthos` coral-specific gene families, including `r n.coral.specific.singletons` that were single-copy in each coral. In Pdam, these coral-specific gene families comprised a total of `r n.coral.specific.genes` genes. As above, the GO terms for these Pdam genes were tested for enrichment relative to the whole Pdam genome using topGO. Nine GO terms were significantly enriched (p < 0.05): copper ion transmembrane transport, signal transduction, tetrahydrofolate biosynthetic process, positive regulation of NFkB transcription factor, caveola assembly, defense response to virus, regulation of transcription, and chromatin silencing at rDNA, and meiotic chromosome segregation. There were 2 genes associated with copper ion transport with swissprot annotations similar to SLC31A1 copper uptake protein. There were 32 genes associated with signal transduction: SwissProt annotations associated with these genes include dopamine receptors, neuropeptide receptors, G-protein coupled receptors, and TRAF (associated with TNF-receptors). NFkB regulation, caveola assembly, and defense response to virus also likely function in immune pathways. Regulation of transcription and chromatin silencing play roles in gene expression, suggesting some coral-specific mechanisms of gene expression regulation. In addition to GO enrichment, we could also look at the blast results of the coral-specific genes, but there are 278 coral-specific ortholog groups making this very difficult to do manually....

![](../coral_specific/coral_specific_enriched_revigo.png)

### Count number of Pdam genes with TNFR cysteine-rich domains annotated by InterProScan
```{bash}
grep "TNFR" interproscan/pdam_ips.renamed.tsv > interproscan/TNFR
cat interproscan/TNFR | cut -f1 | uniq | wc -l
```

## Genes diversified in corals
```{r coral_diversified}
coral <- 1:4
morph <- 5:6
anem <- 7:8
noncoranth <- 5:8
minanth <- apply(counts[,c(coral,morph,anem)],1,min)
sumcor <- apply(counts[,coral],1,sum)

anth <- counts[,1:8]
pgens <- anth[which(minanth>0 & sumcor>20),] # genes to test
divp <- c()
for (g in rownames(pgens)) {
  df <- data.frame(members=rep(NA,8), nonmembers=NA, group=NA)
  rownames(df) <- colnames(anth)
  df["Pdam",1:2] <- c(sum(anth[g,"Pdam"]), sum(anth[-which(rownames(anth) %in% g),"Pdam"])) 
  df["Spis",1:2] <- c(sum(anth[g,"Spis"]), sum(anth[-which(rownames(anth) %in% g),"Spis"])) 
  df["Adig",1:2] <- c(sum(anth[g,"Adig"]), sum(anth[-which(rownames(anth) %in% g),"Adig"])) 
  df["Ofav",1:2] <- c(sum(anth[g,"Ofav"]), sum(anth[-which(rownames(anth) %in% g),"Ofav"])) 
  df["Ampl",1:2] <- c(sum(anth[g,"Ampl"]), sum(anth[-which(rownames(anth) %in% g),"Ampl"])) 
  df["Disc",1:2] <- c(sum(anth[g,"Disc"]), sum(anth[-which(rownames(anth) %in% g),"Disc"])) 
  df["Aipt",1:2] <- c(sum(anth[g,"Aipt"]), sum(anth[-which(rownames(anth) %in% g),"Aipt"])) 
  df["Nema",1:2] <- c(sum(anth[g,"Nema"]), sum(anth[-which(rownames(anth) %in% g),"Nema"])) 
  df[,"group"] <- c(rep("coral",4), rep("noncoral",4))
  mod <- glm(cbind(members, nonmembers) ~ group, data=df, family="binomial")
  lsm <- lsmeans(mod, specs="group")
  lsmtest <- test(contrast(lsm, "trt.vs.ctrl", ref=2), side=">")
  divp[g] <- lsmtest$p.value
}
divadj <- p.adjust(divp,method="fdr")
divs <- pgens[divadj<0.01,]
divs
pdivGens <- dat[dat$Group%in%rownames(divs),]

n.coral.div.orthos <- nrow(divs)
n.coral.div.genes <- sum(divs[,1]) #(in Pdam)


# Get top SwissProt hits for coral-diversified proteins (using longest as representative set)
sphits <- read.table("coral_diversified/cd_longest_sp_tophits.txt", sep="\t")
sphits$V1 <- str_replace_all(sphits$V1, "-RA", "")
fams <- read.table("coral_diversified/longest_genes-fams.txt", row.names=NULL)
sphits <- merge(fams, sphits, by="V1")
sphits$labels <- stringr::str_extract(as.character(sphits$V9), " [^O]*")

# heatmap of gene family size of coral-diversified genes
rot <- function(x) "[<-"(x, , rev(x))
flip <- function(x) apply(x, 2, rot)
png("figures/coral_divgenes_heatmap.png", height=4, width=7, units="in", res=300)
par(mar=c(1,1,3.5,20), mgp=c(1.5,0.25,0), tcl=-0.25)
divs2 <- as.matrix(divs)
divs2 <- t(log(divs2[hclust(dist(divs2))$order,]))
hits <- sphits[match(colnames(divs2), as.character(sphits$V2.x)), "labels"]
pal <- brewer.pal(n=9, "GnBu")
GnBu <- colorRampPalette(brewer.pal(n=9, "GnBu"))
image(flip(divs2), col=GnBu(50), axes=F)
box()
axis(side=3, at=quantile(par("usr")[1:2], c(1, 3, 5, 7, 9, 11, 13, 15)*0.0625),
     labels=rev(c("Pd", "Sp", "Ad", "Of", "Af", "Ds", "Ap", "Nv")), cex.axis=0.75)
abline(v=0.5)
text(par("usr")[2]+0.01, quantile(par("usr")[3:4], seq(0.025,0.975,len=21)), hits, xpd=NA, adj=0, cex=0.75)
mtext(side=3, "Cnidarians", line=2.5, adj=0)
segments(par("usr")[1], 1.19, par("usr")[2], 1.19, xpd=NA, lwd=1.5)
mtext(side=3, "Corals", line=1.3, adj=0.58)
segments(0.5, 1.11, par("usr")[2], 1.11, xpd=NA, lwd=1.5)
text(par("usr")[2]-0.03, par("usr")[4]+0.04, "Top hit in UniProt-SwissProt database (E<1e-10)", xpd=NA, pos=4)
segments(par("usr")[2], 1.03, 2.6, 1.03, xpd=NA, lwd=1.5)
dev.off()

# Table with gene family size and SiwssProt annotations
colnames(sphits)[1] <- "gene"
colnames(fams) <- c("gene", "ortho")
divs$ortho <- rownames(divs)
out <- merge(divs, fams)
out2 <- merge(out, sphits, by="gene")[,c(2:10,1,12,17)]
head(out2)
colnames(out2) <- c("ortholog_group", "Pdam", "Spis", "Adig", "Ofav", "Ampl", "Disc", "Aipt",
                    "Nema", "rep_gene", "SwissProt_tophit", "E-value")
write.table(out2, file="output/Supplementary_Table_S1.txt", quote=F, row.names=F)





# Heatmap with domain structures
rot <- function(x) "[<-"(x, , rev(x))
flip <- function(x) apply(x, 2, rot)
#png("figures/coral_divgenes_heatmap.png", height=4, width=7, units="in", res=300)
par(mar=c(1,1,3.5,1), mgp=c(1.5,0.25,0), tcl=-0.25)
layout(mat=matrix(c(1,1,2,2,2,2), nrow=2))
divs2 <- as.matrix(divs)
divs2 <- t(log(divs2[hclust(dist(divs2))$order,]))
hits <- med_sphits[match(colnames(divs2), as.character(med_sphits$V2.x)), "labels"]
pal <- brewer.pal(n=9, "GnBu")
GnBu <- colorRampPalette(brewer.pal(n=9, "GnBu"))
image(flip(divs2), col=GnBu(50), axes=F)
box()
axis(side=3, at=quantile(par("usr")[1:2], c(1, 3, 5, 7, 9, 11, 13, 15)*0.0625),
     labels=rev(c("Pd", "Sp", "Ad", "Of", "Af", "Ds", "Ap", "Nv")), cex.axis=0.75)
abline(v=0.5)

domains <- read.table("coral_diversified/cd_med_Pfam.txt", sep="\t", fill=T, row.names=NULL, 
                      header=F, stringsAsFactors=T, 
                      col.names=c("protein", "md5", "protein.length", "Pfam", 
                       "signature.acc", "signature.descr", "start", "stop", "score", "status",
                       "rundate", "interpro.acc", "interpro.descr", "GO"))
domains$protein <- str_replace_all(domains$protein, "-RA", "")
ndom <- nlevels(domains$signature.acc)

prots <- split(domains, f=domains$protein)

# get dimensions for plotting
nprot <- dim(divs2)[2]
longest <- max(domains$protein.length)

draw.prot <- function(prot, y=1) with(prot, {
  length <- protein.length[1]
  segments(0, y, length, y)
  rect(start, y-0.3, stop, y+0.3, col=rainbow(ndom)[signature.acc])
  #text(prot$start+(prot$stop-prot$start)/2, y+0.1, labels=signature.descr, srt=45)
})

prots.order <- med_sphits[match(colnames(divs2), as.character(med_sphits$V2.x)), "V1"]

plot(NA, xlim=c(0, longest), ylim=c(0, nprot), axes=F, xlab="", ylab="", yaxs="i", xaxs="i")

for (i in 1:length(prots)) {
  draw.prot(prots[[i]], y=match(names(prots)[[i]], prots.order)-(0.5))
}
text(par("usr")[1]+0.01, quantile(par("usr")[3:4], seq(0.025,0.975,len=21)), hits, xpd=NA, adj=0, cex=0.75)
#dev.off()
```

`r n.coral.div.orthos` ortholog groups found in all cnidarians were significantly diversified in corals. As above, the genes within these families in Pdam (n=`r n.coral.div.genes`) were analyzed using topGO. Nine GO terms were enriched: oligopeptide transport, small GTPase mediated signal transduction, kidney development, protein phosphorylation, Notch signaling pathway, V(D)J recombination, positive regulation of cyclin-dependent protein serine/threonine kinase activity, metabolic process, and attachment of GPI anchor to protein. The GO enrichment suggests a lot of functionality in signaling/possibly immunity. However, with only `r n.coral.div.orthos` gene families in the coral-diversified set, it is feasible to manually look at each these genes. Here are the blast results:

There is high variability in length of the genes clustered into the same ortholog groups. Perhaps the shorter ones are fragmented? In this case, use longest as representative of family?
```{r}
library(Biostrings)
orthomcl3 <- readAAStringSet("fastOrtho/ORTHOMCL3_members.fasta")
hist(width(orthomcl3), main="Length of proteins in ORTHOMCL3 group",
     xlab="Length (amino acids)")
# get longest pdam sequence in orthomcl3
pdam.orthomcl3 <- orthomcl3[grep("pdam", names(orthomcl3))]
pdam.orthomcl3[which.max(width(pdam.orthomcl3))]
```

* ORTHOMCL3: (pdam_00013931): tetratricopeptide repeat containing protein. also similar to kinase suppressor of Ras 2 - involved in MAPK signaling pathway?
#######InterProScan shows this protein contains only a single CATH domain -- no tetratricopeptide repeats.... tetratricopeptide repeat protein is super long while this query is short. 
* ORTHOMCL18: (pdam_00008237): SIGNALING: serine/threonine protein kinase. potential role in apoptosis. (also identified in Bay and Palumbi).
* ORTHOMCL22: (pdam_00016730): similar to polycystic kidney disease protein. calcium channel. role in cilia flow mechanosensation in vertebrates.  may be ECM also (Ramos-Silva).
* ORTHOMCL23: (pdam_00013569): uncharacterized...
* ORTHOMCL29: (pdam_00019450): E3 ubiquitin-protein ligase. (potentially involved in heat-resistance adaptation in corals [Bay and Palumbi]) (upregulated in A. millepora under high temp/co2 [@Kaniewska2015])
* ORTHOMCL32: (pdam_00013642): nr: transposon, retinoschisin, pikachurin. interproscan: C-type lectin domains. calcium-binding.
* ORTHOMCL34: (pdam_00007605): NOTCH SIGNALING: cell differentiation for nematoblasts and oocytes.
* ORTHOMCL36: (pdam_00005261): IMMUNITY / TRANSCRIPTION. zinc finger-containing protein similar to NFX1. controls gene expression of MHC class II genes (immune response). may be involved in apoptosis, ubiquitination...
* ORTHOMCL53: (pdam_00016575): sacsin-like. hsp70 co-chaperone, protein folding?
* ORTHOMCL54: (pdam_00010335): nr: similar to neuropilin (RECEPTOR), or lactadherin (CELL ADHESION), or hemicentin. integrin binding, cell adhesion. (hemicentin identified in Bay and Palumbi).
* ORTHOMCL72: (pdam_00019033): histone demethylase. potential role in epigenetics?
* ORTHOMCL118: (pdam_00016215): tetratricopeptide repeat containing protein. similar to nephrocystin-3, involved in wnt-signaling pathway. (body axis role?) [check Okolova 2012 for Wnt pathway in A millepora].
* ORTHOMCL121: (pdam_00021262): nr: similar to calcium cation channel proteins. this family may be similar to polycystin-like genes, which also function as calcium channels.
* ORTHOMCL125: (pdam_00019619): transposon or pol-like protein, dna integration.
* ORTHOMCL143: (pdam_00014807): nr hits to: coadhesin-like; Hemicentin-1. similar cell-adhesion protein has been identified in the skeletal organic matrix [@Ramos-Silva2013]. 
* ORTHOMCL148: (pdam_00007567): RECEPTOR: nr: similar to G-protein-coupled receptor. interproscan: CUB domain, Concavalin A-like lectin, and leucine-rich repeats. leucine-rich repeats are involved in ligand recognition
* ORTHOMCL151: (pdam_00012572): RECEPTOR? uncharacterized protein. interproscan: Acyl transferase/acyl hydrolase/lysophospholipase domain, which is found in eukaryotic fatty acid synthase enzymes.
* ORTHOMCL160: (pdam_00014870): uncharacterized. hits to kinesin-light-chain-like protein, pro-pol polyprotein, and TRIM71 (E3 ubiquitin-protein ligase).
* ORTHOMCL163 (pdam_00014869): no nr hits. interproscan=pectin lyase fold domain. breaks down algal cell wall? coiled-coil domain-containing protein
* ORTHOMCL171: (pdam_00014105): similar to solute carrier family 15: di/tri-peptide transporters?
* ORTHOMCL273: (pdam_00002639): IMMUNITY: nr: similar to Poly [ADP-ribose] polymerase 14. involved in DNA damage detection/signaling and repair and apoptosis/programmed cell death.

## Coral species-specific gene family expansions
### Gene family size analysis
```{r genefams}
#par(mfrow=c(1,2))
par(mar=c(3,3.75,1,1), mgp=c(1.75,0.25,0), tcl=-0.2)
#A
cols <- c("skyblue", "mediumorchid", "pink1",  "gray60")
pdam.counts <- hist(counts$Pdam[counts$Pdam>0], breaks=2^(seq(0,8,1)), right=FALSE, plot=F)
spis.counts <- hist(counts$Spis[counts$Spis>0], breaks=2^(seq(0,8,1)), right=FALSE, plot=F)
ofav.counts <- hist(counts$Ofav[counts$Ofav>0], breaks=2^(seq(0,8,1)), right=FALSE, plot=F)
adig.counts <- hist(counts$Adig[counts$Adig>0], breaks=2^(seq(0,8,1)), right=FALSE, plot=F)
#plot(pdam.counts$counts, log="y", type="b", cex=0.75, col=cols[1])
#points(spis.counts$counts, log="y", type="b", cex=0.75, col=cols[3])
#points(ofav.counts$counts, log="y", type="b", cex=0.75, col=cols[2])
#points(adig.counts$counts, log="y", type="b", cex=0.75, col=cols[4])
#mod <- lm(log10(pdam.counts$counts)[1:7] ~ log10(pdam.counts$breaks)[1:7])
#mod <- lm(log10(adig.counts$counts)[1:8] ~ log10(adig.counts$breaks)[1:8])
#mod <- lm(log10(ofav.counts$counts)[1:7] ~ log10(ofav.counts$breaks)[1:7])
#mod <- lm(log10(spis.counts$counts)[1:8] ~ log10(spis.counts$breaks)[1:8])
#summary(mod)
#data.frame(pdam=-2.4222, adig=-1.8043, ofav=-2.15569, spis=-1.89900)

logdat <- log10(rbind(pdam.counts$counts, spis.counts$counts,
                    ofav.counts$counts, adig.counts$counts))
logdat[is.infinite(logdat)] <- NA

png(filename="figures/gene_family_size.png", width=4, height=4, units="in", res=300)
bars <- barplot(logdat, beside=T, space=c(0,0), axes=F, col=alpha(cols,0.5),
                xlab="Gene family size", ylab="Number of gene families", xpd=NA)
axis(side=1, at=c(0,4,8,12,16,20,24,28,32),
     labels=c(1,2,4,8,16,32,64,128,256))
axis(side=2, at=c(0,1,2,3,4), labels=c(1,10,100,1000,10000))
legend("topright", pch=22, pt.bg=alpha(cols, 0.5), pt.cex=1.5, bty="n",
       legend=c("Pdam", "Spis", "Ofav", "Adig"))
dev.off()

```

##### Conclusion: Pdam tends to have smallest gene families relative to other coral species. The largest gene family expansions have occurred in Acropora.

### Gene families diversified in each coral species
```{r div_other_corals}
# which are the most diversified gene families in each coral species?
# TEST DIFFS FOR ALL SHARED GENES
corals <- counts[, 1:4]
shared <- corals[apply(corals, 1, min)>0, ]
genestotest <- rownames(shared[apply(shared, 1, function(x) max(x)>=10),])
divp <- c()
for (g in genestotest) {
  adig1 <- sum(corals[g,3])
  adig0 <- sum(corals[-which(rownames(corals) %in% g),3])
  spis1 <- sum(corals[g,2])
  spis0 <- sum(corals[-which(rownames(corals) %in% g),2])
  pdam1 <- sum(corals[g,1])
  pdam0 <- sum(corals[-which(rownames(corals) %in% g),1])
  ofav1 <- sum(corals[g,4])
  ofav0 <- sum(corals[-which(rownames(corals) %in% g),4])
  tab <- matrix(c(adig1, spis1, pdam1, ofav1, adig0, spis0, pdam0, ofav0), nrow=4,
                  dimnames=list("Species"=c("Adig", "Spis", "Pdam", "Ofav"),
                                "GeneFam"=c("Member", "NonMember")))
  tab <- as.table(tab)
  divp[g] <- fisher.test(tab, simulate.p.value=TRUE)$p.value
}
padj <- p.adjust(divp, method = "fdr")
divs <- shared[names(padj[padj < 0.01]), ]


######## identify significant differences
res <- data.frame(matrix(NA, ncol=ncol(divs), nrow=nrow(divs),
                         dimnames=list("Groups"=rownames(divs), "Species"=colnames(divs))))

for (g in rownames(divs)) {
  adig1 <- sum(corals[g,3])
  adig0 <- sum(corals[-which(rownames(corals) %in% g),3])
  spis1 <- sum(corals[g,2])
  spis0 <- sum(corals[-which(rownames(corals) %in% g),2])
  pdam1 <- sum(corals[g,1])
  pdam0 <- sum(corals[-which(rownames(corals) %in% g),1])
  ofav1 <- sum(corals[g,4])
  ofav0 <- sum(corals[-which(rownames(corals) %in% g),4])
  tab <- matrix(c(adig1, spis1, pdam1, ofav1, adig0, spis0, pdam0, ofav0), nrow=4,
                dimnames=list("Species"=c("Adig", "Spis", "Pdam", "Ofav"),
                              "GeneFam"=c("Member", "NonMember")))
  tab <- as.table(tab)
  ptab <- RVAideMemoire::fisher.multcomp(tab, p.method="fdr")
  fullptab <- rcompanion::fullPTable(ptab$p.value)
  ord <- with(data.frame(prop.table(tab, 1))[1:4,], order(Freq, decreasing=T))
  fullptab.ord <- fullptab[ord, ord]
  lett <- multcompView::multcompLetters(fullptab.ord)$Letters
  lett <- lett[order(match(names(lett), colnames(divs)))]
  res[g, ] <- lett
  data.frame(prop.table(tab, 1))[1:4,]
}


obvidivs <- divs[apply(res, 1, function(x) (sum(x=="a")==1) & sum(x=="b")==3), ]
obvires <- res[apply(res, 1, function(x) (sum(x=="a")==1) & sum(x=="b")==3), ]
obvires[obvires=="a"] <- 1
obvires[obvires=="b"] <- 0
obvires2 <- sapply(obvires, as.numeric)
rownames(obvires2) <- rownames(obvires)
colSums(obvires2)

adigdiv <- obvidivs[obvires$Adig==1, ]
adigdiv[rownames(adigdiv)[order(padj[rownames(adigdiv)])],]

spisdiv <- obvidivs[obvires$Spis==1, ]

ofavdiv <- obvidivs[obvires$Ofav==1, ]

pdamdiv <- obvidivs[obvires$Pdam==1, ]

adigdiv


# heatmap of gene family size in each coral species
png("figures/coral_genefams_heatmap.png", height=4, width=2, units="in", res=300)
par(mar=c(1,1,2,1), mgp=c(1.5,0.25,0), tcl=-0.25)
divs2 <- as.matrix(divs)
divs2 <- t(log(divs2[hclust(dist(divs2))$order,]))
pal <- brewer.pal(n=10, "GnBu")
image(divs2, col=pal, axes=F)
box()
axis(side=3, at=quantile(par("usr")[1:2], c(1, 3, 5, 7)*0.125),
     labels=c("Pdam", "Spis", "Adig", "Ofav"), cex.axis=0.75)
points(rep(quantile(par("usr")[1:2], 5*0.125), nrow(adigdiv)),
       quantile(par("usr")[3:4], match(rownames(adigdiv), colnames(divs2))/54) - 0.009433962,
       pch="*", cex=0.8)
points(rep(quantile(par("usr")[1:2], 3*0.125), nrow(spisdiv)),
       quantile(par("usr")[3:4], match(rownames(spisdiv), colnames(divs2))/54) - 0.009433962,
       pch="*", cex=0.8)
points(rep(quantile(par("usr")[1:2], 7*0.125), nrow(ofavdiv)),
       quantile(par("usr")[3:4], match(rownames(ofavdiv), colnames(divs2))/54) - 0.009433962,
       pch="*", cex=0.8)
dev.off()



# Table with gene family size and SiwssProt annotations
sd_sp_tophits <- read.table("species_diversified/species_specific_expansions_tophits.txt",
                            sep="\t")
colnames(sd_sp_tophits)[1] <- "gene"
fams <- read.table("species_diversified/sd_longest_genes-fams.txt")
colnames(fams) <- c("gene", "ortho")
divs$ortho <- rownames(divs)
out <- merge(divs, fams)
out2 <- merge(out, sd_sp_tophits, by="gene")[,c(2,3,4,5,6,1,7,12)]
head(out2)
colnames(out2) <- c("ortholog_group", "Pdam", "Spis", "Adig", "Ofav",
                    "rep_gene", "SwissProt_tophit", "E-value")
write.table(out2, file="output/Supplementary_Table_S2.txt", quote=F, row.names=F)
```

Spis (16) and Adig (11) have most independently diversified gene fams. Ofav=1, Pdam=0.


#### Diversified in Adig
```{r div_adig}
adigdiv
adigdiv
```
** ORTHOMCL15: aug_v2a.12719.t1: nr: uncharacterized protein. InterProScan: nucleoside phosphorylase superfamily, P-loop containing nucleoside trophosphate hydrolase, NACHT nucleoside triphosphatase. "unintegrated": NACHT.
* ORTHOMCL77: aug_v2a.15442.t1: nr: transposon ty3 gag-pol polyprotein. InterProScan: aspartic peptidase domain/catalytic peptidase retrovirus / tetropepsins, and reverse transcriptase domain -> GO: proteolysis, aspartic-type endopeptidase activity (hydrolysis of peptide bonds). "Retroviral reverse transcriptase is synthesised as part of the POL polyprotein that contains; an aspartyl protease, a reverse transcriptase, RNase H and integrase. POL polyprotein undergoes specific enzymatic cleavage to yield the mature proteins." (InterPro RT_dom documentation)
** ORTHOMCL80: aug_v2a.03626.t1: nr: uncharacterized protein / probably serine/threonine-protein kinase roco6. SMART: Death domain. InterProScan: P-loop containing nucleoside triphosphate hydrolase, C-terminal of Roc (COR) domain, and Death domain -> GO: signal transduction and protein binding./10331/
** ORTHOMCL298: aug_v2a.15546.t1: nr: NLRC3-like. SMART: many leucine-rich repeats (LRR domains). InterProScan: "unintegrated" NACHT domain (apoptosis/MHC recognition)
** ORTHOMCL472: aug_v2a.13941.t1: nr: MAM and LDL-receptor class A domain-containing protein 2-like isoform. Interproscan: FN3, CUB, and MAM domains. may be membrane associated, signal receptor, protein binding.
** ORTHOMCL502: aug_v2a.24492.t1: nr: uncharacterized protein. InterProScan: tetratricopeptide-like helical domain superfamily. protein binding.
* ORTHOMCL2424: aug_v2a.12383.t1: nr: piggyBac transposable element-derive protein 4-like. InterProScan: transposase domain DDE_Tnp_1_7
** ORTHOMCL3871: aug_v2a.10418.t1: nr: fibrinogen alpha-2 chain-like. i think it is actually missing the fibrinogen portion within its closest blast hits that contain it. SMART found no confident domains. InterProScan: PAN/Apple domain. swissprot: lowest evalue is 0.1....
** ORTHOMCL733: aug_v2a.24144.t1: nr: probable ephrin type-B receptor. SMART: fibronectin type 3 domain. InterProScan: immunoglobin, fibronectin, "unintegrated" ephrin receptor
** ORTHOMCL9: aug_v2a.10331.t1: nr: dynein heavy chain 5 or 8. InterProScan: Dynein heavy chain family membership - lots of domains. 

#### Diversified in Spis
```{r div_spis}
spisdiv
```
* ORTHOMCL23: Spis24421: 1) collagen-like protein, or 2) complement c1q and tumor necrosis factor-related protein 9. has transposase domain. InterProScan: transmembrane structure, cysteine-rich insect antifreeze protein, collagen triple helix repeat - structural?
** ORTHOMCL100: Spis22893: nr: Proprotein convertase subtilisin/kexin type 6 / furin-like. InterProScan: protein family: peptidase s8, subtilisin-related. kexin/furin domain and galactose-binding-like domain.
* ORTHOMCL114: Spis24333: 1) pol polyprotein from type-1 retrotransposable element, 2) tyrosine kinase receptor. InterProScan: reverse transcriptase domain.
* ORTHOMCL120: Spis22596: nr: phosphatidate phosphatase PPAPDC1A / Myosin light chain kinase, smooth muscle / has reverse transcriptase domain and GIY-YIG endonuclease domain. InterProScan: 2x GIY-YIG endonuclease superfamily, 2x reverse transcriptase domain, zinc-finger. nucleic acid binding GO.
** ORTHOMCL121: Spis2941: nr: transient receptor potential cation channel subfamily A member 1-like. INterProScan: ion transport protein
** ORTHOMCL181: Spis322: similar to inhibitor of growth protein (ING protein), tumor suppressor?. InterProScan: Exonuclease, phage-type/RecB, C-terminal / ING family, zinc finger, Ulp1 protease family, C-terminal catalytic domain
* ORTHOMCL286: Spis24261: nr: RNA-directed DNA polymerase from mobile element jockey / Fibrilin-1. InterProScan: Endonuclease/exonuclease/phosphatase, DUF, Alkylated DNA repair protein AlkB, homologue 8, N-terminal
** ORTHOMCL372: Spis8530: nr: serine/threonine-protein kinase/endoribonuclease IRE1/Eq ubiquitin-protein ligase/G-protein signaling modulator 2. InterProScan: Coils.
* ORTHOMCL517: Spis11534: nr: RNA-directed DNA polymerase from mobile element jockey / Beta-hexosaminidase 1. InterProScan: reverse transcriptase domain
* ORTHOMCL606: Spis6398: nr: Tachylectin-2 / uncharacterized transposon-derived protein. InterProScan: Ribonuclease H-like domain, INtegrase core domain, Integrase catalytic domain profile, 
** ORTHOMCL706: Spis16969: nr: repressor of the inhibitor of the protein kinase-like / Phosphatidylinositol-glycan-specific phospholipase D. InterProScan: hAT family C-terminal dimerisation region, Ribonuclease H-like domain, Coil.
* ORTHOMCL707: Spis21566: nr: RNA-directed DNA polymerase from mobile element jockey / Dimethyladenosine transferase 1, mitochondrial / Coiled-coil domain-containing protein lobo-like. InterProScan: Reverse transcriptase domain.
* ORTHOMCL851: Spis21717: nr: RNA-directed DNA polymerase from transposon X-element / Nephrocystin-4 / Twinfilin-1 / G-protein coupled receptor. InterProScan: Reverse transcriptase domainq
* ORTHOMCL1742: Spis24269: nr: RNA-directed DNA polymerase / Long-chain-fatty-acid--CoA ligase 5 / FMRF-amide neuropeptide / REST corepressor 2. InterProScan: Reverse transcriptase domain.
* ORTHOMCL1901: Spis13079: nr: Pogo transposable element with KRAB domain / Arylsulfatase B. InterProScan: Winged helix-turn-helix DNA-binding domain, Homeobox domain-like, DDE superfamily endonuclease, Tc5 transposase DNA-binding domain, HTH CenpB-type DNA-binding domain, Transposase IS3/Is911family


#### Diversified in Ofav
```{r div_ofav}
ofavdiv
```
* ORTHOMCL2848: ofav_00010370: nr: Metabotropic glutamate receptor 3 / ?

#### Diversified in Pdam
```{r div_pdam}
pdamdiv
```

.....no gene families are significantly diversified in Pdam relative to all three other coral species. There are some gene families in which Pdam and another species have larger families than the other two species, but none for which Pdam is significantly higher than all three other corals.

* "The functional categories most prone to lineage-specific expansion are structural proteins, enzymes involved in an organism's response to pathogens and environmental stress, and various components of signaling pathways responsible for specificity, including ubiquitin ligase E3 subunits" (Lespinet et al. 2002)

* similar gene families have been expanded in sea cucumber genome.

***

## Pdam-specific genes

However, there are genes that were found in Pdam with NO ORTHOLOGS in the other corals. These Pdam-specific genes include...:

```{r pdam_specific}
pdam.specific <- apply(counts[,-1], 1, function(x) max(x)==0)
pdam.specific.orthos <- counts[pdam.specific, ]
n.pdam.specific.orthos <- nrow(pdam.specific.orthos)
n.pdam.specific.singletons <- sum(pdam.specific.orthos$Pdam==1)
n.pdam.specific.genes <- sum(pdam.specific.orthos[,1])
```

This is a functional profile of the genes in Pdam for which *no orthologs were found in any other genome* (with an e-value cutoff of 1e-5), including the other corals and the other inverts. There were `r n.pdam.specific.orthos` pdam-specific ortholog groups, including `r n.pdam.specific.singletons` singletons, containing a total of `r n.pdam.specific.genes` genes. Eleven GO terms were significantly enriched: G-protein coupled receptor signaling pathway, bioluminescence, activation of NFkappaB-inducing kinase activity, positive regulation of JNK cascade, and signal transduction.

![](../pdam_specific/pdam_specific_enriched_revigo.png)

Significantly enriched functionality in Pdam-specific genes:

* miRNA mediated inhibition of translation:  
    + 2 genes similar to E3 ubiquitin-protein ligase  
    + gene expression regulation?  
* NF-kappaB-inducing kinase activity AND positive regulation of JNK cascade:  
    + 4 genes received both of these annotations: similar to TNF receptor-associated factor/TRAF: promotes ubiquitination, role in cell survival/apoptosis.  
    + these genes were most highly upregulated in heat-stressed corals (Barshis et al. 2013)  
* DNA damage checkpoint:  
    + 3 genes: no great hist to nr, but have death domains  
    + possible role in apoptosis?  
* G-protein coupled receptor signaling pathway:  
    + 134 genes...similar to various receptors  
* cellular response to stress:  
    + 9 genes: some unknown proteins with death domains (same prots annotated as DNA damage checkpoint), some with mitochondrial-eating protein domains (regulate mitochondrial damage and repair)  
* DNA integration:  
    + 4 genes: pro-pol polyprotein with rve domain (integrase)  
    + converts viral RNA into dsDNA  
* carbohydrate biosynthetic process:  
    + 3 genes: 1 protein with a DNA repair rad52 domain, 2 similar to carbohydrate sulfotransferase  
* bioluminescence:  
    + 6 genes: similar to GFP-like fluorescent chromoprotein  
* copper ion transmembrane transport:  
    + 2 genes: similar to CTR2 copper transport  
    + copper important for photosynthesis, coral may have evolved mechanisms to transport copper to the symbionts. In mycorrhizal associations, fungi deliver copper to the host plant (Gonzalez-Guerrero et al. 2016).
    
    #old text from ms:
    Of the Pdam-specific genes, 11 GO terms were significantly enriched (Fig. 4):  
* miRNA mediated inhibition of translation:  2 genes similar to E3 ubiquitin-protein ligase. gene expression regulation?  
* NF-kappaB-inducing kinase activity AND positive regulation of JNK cascade: 4 genes received both of these annotations: similar to TNF receptor-associated factor/TRAF: promotes ubiquitination, role in cell survival/apoptosis. similar genes were most highly upregulated in heat-stressed corals (Barshis et al. 2013)  
* DNA damage checkpoint: 3 genes: no great hist to nr, but have death domains. possible role in apoptosis?  
* G-protein coupled receptor signaling pathway:  134 genes...similar to various receptors  
* cellular response to stress:  9 genes: some unknown proteins with death domains (same prots annotated as DNA damage checkpoint), some with mitochondrial-eating protein domains (regulate mitochondrial damage and repair)  
* DNA integration:  4 genes: pro-pol polyprotein with rve domain (integrase). converts viral RNA into dsDNA. could be transposable elements?  
* carbohydrate biosynthetic process: 3 genes: 1 protein with a DNA repair rad52 domain, 2 similar to carbohydrate sulfotransferase  
* bioluminescence:  6 genes: similar to GFP-like fluorescent chromoprotein  
* copper ion transmembrane transport:  2 genes: similar to CTR2 copper transport. copper important for photosynthesis, coral may have evolved mechanisms to transport copper to the symbionts. In mycorrhizal associations, fungi deliver copper to the host plant (Gonzalez-Guerrero et al. 2016).
    
    
"We also found elevated rates of evolution in several other functional groups such as management of membrane vesicles, transmembrane transport of ions and organic molecules, cell adhesion, and oxidative stress response." [@Voolstra2011]
    
